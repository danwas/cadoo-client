{"ast":null,"code":"import _toConsumableArray from\"/Users/daniel/Desktop/DH2465-cadoo/code/frontend/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/Users/daniel/Desktop/DH2465-cadoo/code/frontend/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _taggedTemplateLiteral from\"/Users/daniel/Desktop/DH2465-cadoo/code/frontend/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral\";function _templateObject2(){var data=_taggedTemplateLiteral([\"\\n    width: 100%;\\n    height: 100%;\\n    -webkit-transform: scaleX(-1);\\n    transform: scaleX(-1);\\n    border-radius: 10px;\\n    border: 2px solid white;\\n    border-color: rgb(66, 66, 66);\\n\"]);_templateObject2=function _templateObject2(){return data;};return data;}function _templateObject(){var data=_taggedTemplateLiteral([\"\\n    width: 75%;\\n    height: 75%;\\n    -webkit-transform: scaleX(-1);\\n    transform: scaleX(-1);\\n    border-radius: 10px;\\n    border: 2px solid white;\\n    border-color: rgb(66, 66, 66);\\n\"]);_templateObject=function _templateObject(){return data;};return data;}import React,{useEffect,useRef,useState}from\"react\";import{useLocation,useHistory}from\"react-router-dom\";import{ButtonGroup,ToggleButtonGroup,ToggleButton,Button,Navbar,Nav,NavItem,FormControl}from'react-bootstrap';import io from\"socket.io-client\";import Peer from\"simple-peer\";import styled from\"styled-components\";import{AuthContext,useAuthContext}from\"../libs/Auth\";import\"../css/Room.css\";var img_mute=require('../images/mute.png');var img_video=require('../images/video.png');var RemoteStyledVideo=styled.video(_templateObject());var LocalStyledVideo=styled.video(_templateObject2());var Video=function Video(props){var ref=useRef();useEffect(function(){props.peer.on(\"stream\",function(stream){ref.current.srcObject=stream;});},[]);return/*#__PURE__*/React.createElement(RemoteStyledVideo,{playsInline:true,autoPlay:true,ref:ref});};var videoConstraints={height:window.innerHeight,width:window.innerWidth};var Room=function Room(props){var _useState=useState([]),_useState2=_slicedToArray(_useState,2),peers=_useState2[0],setPeers=_useState2[1];var _useState3=useState(1),_useState4=_slicedToArray(_useState3,2),toggleAudio=_useState4[0],setToggleAudio=_useState4[1];var _useState5=useState(1),_useState6=_slicedToArray(_useState5,2),toggleVideo=_useState6[0],setToggleVideo=_useState6[1];var socketRef=useRef();var userVideo=useRef();var peersRef=useRef([]);var history=useHistory();var context=useAuthContext(AuthContext);var username=context.authTokens;var roomID=props.match.params.roomID;useEffect(function(){socketRef.current=io.connect(\"/\");navigator.mediaDevices.getUserMedia({video:videoConstraints,audio:true}).then(function(stream){userVideo.current.srcObject=stream;socketRef.current.emit(\"join-room\",{roomID:roomID,name:username});socketRef.current.on(\"all-users\",function(users){var peers=[];users.forEach(function(participant){var peer=createPeer(participant.name,participant.id,socketRef.current.id,stream);peersRef.current.push({peerID:participant.id,peerName:participant.name,peer:peer});peers.push({peerID:participant.id,peerName:participant.name,peer:peer});});setPeers(peers);});socketRef.current.on(\"user-joined\",function(payload){var peer=addPeer(payload.name,payload.signal,payload.callerID,stream);peersRef.current.push({peerID:payload.callerID,peerName:payload.name,peer:peer});var peerObj={peer:peer,peerID:payload.callerID,peerName:payload.name};setPeers(function(users){return[].concat(_toConsumableArray(users),[peerObj]);});});socketRef.current.on(\"receiving-returned-signal\",function(payload){var item=peersRef.current.find(function(p){return p.peerID===payload.id;});item.peer.signal(payload.signal);});socketRef.current.on(\"user-left\",function(id){var peerObj=peersRef.current.find(function(p){return p.peerID===id;});if(peerObj){peerObj.peer.destroy();}var peers=peersRef.current.filter(function(p){return p.peerID!==id;});peersRef.current=peers;setPeers(peers);});});},[]);function createPeer(name,userToSignal,callerID,stream){var peer=new Peer({initiator:true,trickle:false,stream:stream});peer.on(\"signal\",function(signal){socketRef.current.emit(\"sending-signal\",{name:name,userToSignal:userToSignal,callerID:callerID,signal:signal});});return peer;}function addPeer(name,incomingSignal,callerID,stream){var peer=new Peer({initiator:false,trickle:false,stream:stream});peer.on(\"signal\",function(signal){socketRef.current.emit(\"returning-signal\",{name:name,signal:signal,callerID:callerID});});peer.signal(incomingSignal);return peer;}function LeaveRoom(){socketRef.current.emit(\"disconnect-button\");stopBothVideoAndAudio(userVideo.current.srcObject);socketRef.current.disconnect();history.push({pathname:'/'});}function stopBothVideoAndAudio(stream){stream.getTracks().forEach(function(track){if(track.readyState=='live'){track.stop();}});}var handleChange=function handleChange(val){if(val==0){if(toggleAudio==1){alert(\"muted\");setToggleAudio(0);}else{alert(\"not muted\");setToggleAudio(1);}}else if(val==1){if(toggleVideo==1){alert(\"video off\");setToggleVideo(0);}else{alert(\"video on\");setToggleVideo(1);}}};return/*#__PURE__*/React.createElement(\"div\",{className:\"Room\"},/*#__PURE__*/React.createElement(\"div\",{className:\"column-left\"},/*#__PURE__*/React.createElement(\"div\",{className:\"buttons-container\"},/*#__PURE__*/React.createElement(Button,{className:\"buttons-leave\",onClick:LeaveRoom},\"Leave\"),/*#__PURE__*/React.createElement(ToggleButtonGroup,{type:\"checkbox\",onChange:handleChange},/*#__PURE__*/React.createElement(ToggleButton,{className:\"buttons-mute-off\",value:0},/*#__PURE__*/React.createElement(\"img\",{src:img_mute,className:\"mute-img\"})),/*#__PURE__*/React.createElement(ToggleButton,{className:\"buttons-mute-off\",value:1},/*#__PURE__*/React.createElement(\"img\",{src:img_video,className:\"mute-img\"})))),/*#__PURE__*/React.createElement(\"div\",{className:\"local-video-container\"},/*#__PURE__*/React.createElement(LocalStyledVideo,{muted:true,ref:userVideo,autoPlay:true,playsInline:true})),/*#__PURE__*/React.createElement(\"div\",{class:\"chat\"},/*#__PURE__*/React.createElement(\"p1\",null,\"H\\xE4r kommer en chat!\"))),/*#__PURE__*/React.createElement(\"div\",{className:\"column-right\"},/*#__PURE__*/React.createElement(Navbar,{className:\"navbar-room\"},/*#__PURE__*/React.createElement(Navbar.Brand,{className:\"nav-item\"},\"Hi \",username,\"! You are Cadooing about - Chess\")),/*#__PURE__*/React.createElement(\"div\",{className:\"lower-video-bar\"},/*#__PURE__*/React.createElement(\"div\",{className:\"remote-video-container\"},peers.map(function(peer){return/*#__PURE__*/React.createElement(\"div\",{className:\"remote-video-item\"},/*#__PURE__*/React.createElement(Video,{key:peer.peerID,peer:peer.peer}),/*#__PURE__*/React.createElement(\"h3\",null,peer.peerName));})))));};export default Room;// filter(peer => peer.peerID !== socketRef.current.id)\n// {peers.map((peer) => {\n//     return (\n//         <Video key={peer.peerID} peer={peer.peer} />    \n//     );\n// })}","map":{"version":3,"sources":["/Users/daniel/Desktop/DH2465-cadoo/code/frontend/client/src/containers/Room.js"],"names":["React","useEffect","useRef","useState","useLocation","useHistory","ButtonGroup","ToggleButtonGroup","ToggleButton","Button","Navbar","Nav","NavItem","FormControl","io","Peer","styled","AuthContext","useAuthContext","img_mute","require","img_video","RemoteStyledVideo","video","LocalStyledVideo","Video","props","ref","peer","on","stream","current","srcObject","videoConstraints","height","window","innerHeight","width","innerWidth","Room","peers","setPeers","toggleAudio","setToggleAudio","toggleVideo","setToggleVideo","socketRef","userVideo","peersRef","history","context","username","authTokens","roomID","match","params","connect","navigator","mediaDevices","getUserMedia","audio","then","emit","name","users","forEach","participant","createPeer","id","push","peerID","peerName","payload","addPeer","signal","callerID","peerObj","item","find","p","destroy","filter","userToSignal","initiator","trickle","incomingSignal","LeaveRoom","stopBothVideoAndAudio","disconnect","pathname","getTracks","track","readyState","stop","handleChange","val","alert","map"],"mappings":"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","sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\nimport { useLocation, useHistory } from \"react-router-dom\";\nimport { ButtonGroup, ToggleButtonGroup, ToggleButton, Button, Navbar, Nav, NavItem, FormControl } from 'react-bootstrap';\nimport io from \"socket.io-client\";\nimport Peer from \"simple-peer\";\nimport styled from \"styled-components\";\nimport { AuthContext, useAuthContext } from \"../libs/Auth\";\nimport \"../css/Room.css\"; \n\n\nconst img_mute = require('../images/mute.png');\nconst img_video = require('../images/video.png');\n\n\nconst RemoteStyledVideo = styled.video`\n    width: 75%;\n    height: 75%;\n    -webkit-transform: scaleX(-1);\n    transform: scaleX(-1);\n    border-radius: 10px;\n    border: 2px solid white;\n    border-color: rgb(66, 66, 66);\n`;\n\nconst LocalStyledVideo = styled.video`\n    width: 100%;\n    height: 100%;\n    -webkit-transform: scaleX(-1);\n    transform: scaleX(-1);\n    border-radius: 10px;\n    border: 2px solid white;\n    border-color: rgb(66, 66, 66);\n`;\n\n\nconst Video = (props) => {\n    const ref = useRef();\n\n    useEffect(() => {\n        props.peer.on(\"stream\", stream => {\n            ref.current.srcObject = stream;\n        })\n    }, []);\n\n    return (\n        <RemoteStyledVideo playsInline autoPlay ref={ref} />\n    );\n}\n\nconst videoConstraints = {\n    height: window.innerHeight,\n    width: window.innerWidth,\n};\n\nconst Room = (props) => {\n    const [peers, setPeers] = useState([]);\n    const [toggleAudio, setToggleAudio] = useState(1);\n    const [toggleVideo, setToggleVideo] = useState(1);\n    const socketRef = useRef();\n    const userVideo = useRef();\n    const peersRef = useRef([]);\n    const history = useHistory();\n    \n    const context = useAuthContext(AuthContext);\n    const username = context.authTokens;\n    const roomID = props.match.params.roomID;\n\n\n    useEffect(() => {\n        socketRef.current = io.connect(\"/\");\n        \n        navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: true }).then(stream => {\n            userVideo.current.srcObject = stream;\n            socketRef.current.emit(\"join-room\", { \n                roomID: roomID, \n                name: username\n            });\n            \n            socketRef.current.on(\"all-users\", users => {\n                const peers = [];\n                users.forEach(participant => {\n                    const peer = createPeer(participant.name, participant.id, socketRef.current.id, stream);\n\n                    peersRef.current.push({\n                        peerID: participant.id,\n                        peerName: participant.name,\n                        peer,\n                    })\n                    peers.push({\n                        peerID: participant.id,\n                        peerName: participant.name,\n                        peer\n                    });\n                })\n                setPeers(peers);\n            });\n\n            socketRef.current.on(\"user-joined\", payload => {\n                const peer = addPeer(payload.name, payload.signal, payload.callerID, stream);\n                peersRef.current.push({\n                    peerID: payload.callerID,\n                    peerName: payload.name,\n                    peer,\n                })\n\n                const peerObj = {\n                    peer,\n                    peerID: payload.callerID,\n                    peerName: payload.name\n                }\n                setPeers(users => [...users, peerObj]);\n            });\n\n            socketRef.current.on(\"receiving-returned-signal\", payload => {\n                const item = peersRef.current.find(p => p.peerID === payload.id);\n                item.peer.signal(payload.signal);\n            });\n\n            socketRef.current.on(\"user-left\", id => {\n                const peerObj = peersRef.current.find(p => p.peerID === id);\n                if (peerObj) {\n                    peerObj.peer.destroy();\n                }\n                const peers = peersRef.current.filter(p => p.peerID !== id);\n                peersRef.current = peers;\n                setPeers(peers);\n\n            });\n           \n        })\n    }, []);\n\n    function createPeer(name, userToSignal, callerID, stream) {\n        const peer = new Peer({\n            initiator: true,\n            trickle: false,\n            stream,\n        });\n\n        peer.on(\"signal\", signal => {\n            socketRef.current.emit(\"sending-signal\", { name, userToSignal, callerID, signal })\n        })\n\n        return peer;\n    }\n\n    function addPeer(name, incomingSignal, callerID, stream) {\n        const peer = new Peer({\n            initiator: false,\n            trickle: false,\n            stream,\n        })\n       \n        peer.on(\"signal\", signal => {\n            socketRef.current.emit(\"returning-signal\", { name, signal, callerID })\n        })\n\n        peer.signal(incomingSignal);\n\n        return peer;\n    }\n\n    function LeaveRoom() {\n        socketRef.current.emit(\"disconnect-button\");\n        stopBothVideoAndAudio(userVideo.current.srcObject);\n        socketRef.current.disconnect();\n        history.push({\n            pathname: '/'\n        });  \n    }\n\n    function stopBothVideoAndAudio(stream) {\n        stream.getTracks().forEach(function(track) {\n            if (track.readyState == 'live') {\n                track.stop();\n            }\n        });\n    }\n\n    const handleChange = (val) => {\n        if (val == 0) {\n            if (toggleAudio == 1) {\n                alert(\"muted\");\n                setToggleAudio(0);\n            } else {\n                alert(\"not muted\");\n                setToggleAudio(1);\n            }\n\n        } else if (val == 1) {\n            if (toggleVideo == 1) {\n                alert(\"video off\");\n                setToggleVideo(0);\n            } else {\n                alert(\"video on\");\n                setToggleVideo(1);\n            }\n        }\n    }\n\n\n\n    return (\n            <div className=\"Room\">\n                <div className=\"column-left\">\n\n                    <div className=\"buttons-container\">\n                        \n                            <Button \n                                className=\"buttons-leave\" \n                                onClick={ LeaveRoom }\n                                \n                                >Leave</Button>\n\n                            <ToggleButtonGroup type=\"checkbox\" onChange={ handleChange }>\n                                <ToggleButton \n                                    className=\"buttons-mute-off\" \n                                    value={0}>\n                                    \n                                    <img\n                                        src= {img_mute}\n                                        className= 'mute-img'\n                                    />\n                                </ToggleButton>\n\n                                <ToggleButton \n                                    className=\"buttons-mute-off\" \n                                    value={1}>\n                                        \n                                    <img\n                                        src= {img_video}\n                                        className= 'mute-img'\n                                    />\n                                </ToggleButton>\n                            </ToggleButtonGroup>\n                        \n                    </div>\n\n                    <div className=\"local-video-container\">    \n                        <LocalStyledVideo muted ref={userVideo} autoPlay playsInline />\n                    </div>\n\n                    <div class=\"chat\">\n                        <p1>Här kommer en chat!</p1>\n                    </div>\n                </div>\n\n                <div className=\"column-right\">\n                    <Navbar className=\"navbar-room\">\n                        <Navbar.Brand className=\"nav-item\">Hi {username}! You are Cadooing about - Chess</Navbar.Brand>\n                    </Navbar>\n\n                    <div className=\"lower-video-bar\">\n                        <div className=\"remote-video-container\">\n                            {peers.map((peer) => {\n                                return (\n                                    <div className=\"remote-video-item\">\n                                        <Video key={peer.peerID} peer={peer.peer}/>\n                                        <h3>{peer.peerName}</h3>\n                                    </div>\n                                );\n                            })}\n                        </div>\n\n                    </div>\n                </div>\n            </div>         \n    );\n};\n\nexport default Room;\n\n\n// filter(peer => peer.peerID !== socketRef.current.id)\n\n// {peers.map((peer) => {\n\n                    \n//     return (\n//         <Video key={peer.peerID} peer={peer.peer} />    \n//     );\n// })}"]},"metadata":{},"sourceType":"module"}